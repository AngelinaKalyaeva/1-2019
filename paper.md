# Формирование модели непрерывного мониторинга работоспособности и бизнес-процессов интернет-магазина с возможностью оперативного оповещения.  

Ключевые слова: система мониторинга, интернет-магазин, Prometheus, ClickHouse, Grafana, GraphQL  

## Аннотация  

В настоящее время интернет-магазины используются повсеместно. Для получения большей прибыли и предотвращения потери клиентов компаниям, имеющим свои интернет-магазины, важно знать об изменении любых параметров работы сервиса. Для обеспечения решения данной проблемы используются системы мониторинга. В данной статье были рассмотрены существующие на рынке системы мониторинга, их достоинства и недостатки. Был сделан вывод о целесообразности разработки нового решения, которое обеспечивает единый мониторинг работоспособности и бизнес-процессов интернет-магазина. В результате рассмотрения возможных решений для поставленных задач была выдвинута гипотеза о формировании комбинированной модели системы мониторинга. 

## Введение    

С учетом современных темпов жизни необходимо обеспечение возможности постоянного контроля за показателями бизнес-процессов, например, контроль за посещаемостью интернет-магазина пользователями, за динамикой продаж, за популярностью товара и т.д. Также необходима возможность оперативного оповещения об изменении метрик для корректировки не только планов продаж и закупок, но и политики компании в целом. Помимо прочего, важно как можно раньше узнавать о возможных проблемах работоспособности интернет-магазина, которые могут привести не только к потере прибыли от несовершенных покупок на момент недоступности сервиса, но и к потере аудитории в целом.  

Таким образом, объектом исследования являются существующие подходы к мониторингу. Предметом исследования является процесс сбора метрик для построения системы мониторинга. Целью данной работы является формирование модели непрерывного мониторинга работоспособности и бизнес-процессов компании с возможностью оперативного оповещения.  

Для достижения поставленной цели необходимо выполнить следующие задачи:  
1. Изучить существующие подходы к мониторингу  
2. Провести обзор существующих систем мониторинга с точки зрения обозначенных критериев:
   * возможность оповещения
   * возможность обработки метрик работоспособности, например, время ответа сервера
   * возможность обработки бизнес-метрик, например, количество продаж
   * возможность расширения набора метрик
3. Выдвинуть гипотезы о формировании модели системы мониторинга бизнес-процессов и работоспособности интернет-магазина

## Сравнение аналогов   

### Принцип отбора аналогов    

В первую очередь был выполнен обзор предметной области для установления целесообразности разработки системы мониторинга. Для выбора аналогов к рассмотрению был произведен поиск в сети интернет, а также упоминания в системе поиска научных статей "Cyberleninka". Поиск аналогов проводился с использованием ключевых слов: система, сервис, мониторинг, аналитика, метрика, работоспособность, бизнес-процессы, сайт, интернет-магазин. Примеры поисковых запросов: "Сервис мониторинга работоспособности сайта", "Сервис аналитики метрик интернет-магазина". В качестве аналогов отбирались системы, которые позволяют проводить мониторинг работоспособности сайта, в частности интернет-магазина, либо системы, которые позволяют осуществлять бизнес-аналитику.  

### Аналоги 

1. #### Google Analytics
Бесплатный сервис для создания детальной статистики веб-аналитики. Данный сервис позволяет оценить количество уникальных посетителей, количество просмотренных страниц, среднее время, проведенное на сайте интернет-магазина [1]. Google Analytics позволяет отслеживать и бизнес-метрики. Для интернет-магазина доступны следующие события для анализа: добавление пользователем товара в корзину, совершение покупки и др. Отчеты о работе можно получать по настроенному расписанию, например, раз в день, раз в неделю, раз в месяц [2]. Плюсом данного сервиса является возможность настраивать параметры, которые необходимо отслеживать.  

2. #### Host-tracker   
Сервис проверки доступности сайтов и серверов. Данный сервис позволяет определить доступность, а также время отклика и скорость загрузки сайта. Также данный сервис позволяет определить использование оборудования сервера [3]. Плюсом является наличие возможности получать уведомления о проблемах посредством sms-сообщений, email-сообщений или телефонных звонков.  

3. #### Яндекс.метрика  
Инструмент веб-аналитики. Яндекс.метрика предоставляет возможность настраивать необходимые параметры для мониторинга. Данный сервис позволяет отслеживать такие параметры, как средний чек покупки, объемы продаж в денежном и количественном эквиваленте и т.д.[4]  

4. #### Ping-admin  
Сервис, позволяющий осуществлять круглосуточный мониторинг доступности и работоспособности интернет-магазина [5]. Данный сервис предоставляет возможность получать уведомления в виде сообщений или звонков в случае, когда один из сервисов на сервере стал недоступным.  

5. #### Kuoll  
Сервис мониторинга работоспособности и устранения ошибок в интернет-магазинах. Ошибки, найденные данным сервисом, группируются и отображаются в порядке частоты появления [6]. Данный сервис имеет возможность рассылки уведомлений о критических ошибках в Slack или Telegram.  

### Критерии сравнения аналогов  

1.  #### Возможность обработки метрик работоспособности  
Возможность обработки метрик работоспособности приложения является важным критерием, так как позволяет отслеживать технические показатели, такие как, время ответа сервера, количество потребляемых ресурсов (память, CPU и др.), количество ошибок и т.д., а также выполнять их корректировку в случае необходимости.

2.  #### Возможность обработки бизнес-метрик
Возможность непрерывного мониторинга бизнес-метрик является важным критерием, так как позволяет отслеживать изменение показателей продаж и интереса пользователей. Получение подобной информации необходимо для возможного изменения стратегии деятельности интернет-магазина с целью привлечения большей аудитории клиентов.

3.  #### Возможность оповещения 
Возможность оперативного оповещения также является одним из важнейших критериев, так как в случае обнаружения ошибок работоспособности важно как можно раньше получать информацию о возникших неполадках с целью их скорейшего устранения и минимизации возможной потери прибыли на момент недоступности интернет-магазина. Также важно своевременно получать информацию и об изменении бизнес-метрик для обеспечения возможности их оперативной корректировки.

4.  #### Возможность расширения набора метрик  
Возможность расширения набора метрик является важным критерием, так как бизнес-процессы имеют свойство постоянного изменения, в результате чего некоторые метрики устаревают и для них необходима корректировка. 

### Таблица сравнения по критериям  

|   | Google analytics | Host-tracker | Яндекс.метрика | Ping-admin | Kuoll |
|---|:-----------------|:-------------|:---------------|:-----------|:------|
|Обработка метрик работоспособности | нет | да | нет | да | да |
|Обработка бизнес-метрик | да | нет | да | нет | нет |
|Возможность оповещений | нет | да | нет | да | да |
|Расширение набора метрик | да | нет | да | нет | нет |    

Таблица 1 - Сравнение аналогов по выделенным критериям  

### Выводы по итогам сравнения  

В результате обзора аналогов и сравнения их по выделенным критериям [Таблица 1] можно сделать вывод, что среди рассмотренных программных инструментов нет решения, которое удовлетворяет всем описанным выше критериям. Например, такие рассмотренные сервисы, как Яндекс.метрика и Google Analytics не имеют возможности осуществлять мониторинг работоспособности интернет-магазина. А такие сервисы, как Host-tracker, Ping-admin и Kuoll, наоборот, не имеют возможности осуществлять мониторинг бизнес-метрик. Таким образом, можно сделать вывод о целесообразности разработки приложения, способного осуществлять непрерывный мониторинг работоспособности интернет-магазина и бизнес-метрик с возможностью оперативного оповещения.

## Выбор метода решения    

Разрабатываемое решение должно представлять собой программный продукт для мониторинга работоспособности и бизнес-процессов интернет-магазина.
Данная система мониторинга должна обладать следующими качествами:  

1. Возможность сбора и обработки метрик работоспособности интернет-магазина для поддержания постоянной доступности сервиса для пользователей.  

2. Возможность сбора и обработки бизнес-метрик для формирования грамотной стратегии продвижения интернет-магазина с целью повышения продаж и получения прибыли.  

3. Обеспечение возможности визуализации исследуемых данных для проведения дальнейшего анализа.  

4. Возможность оперативного оповещения для своевременного решения возникающих проблем и минимизации возможной потери прибыли за счет несовершенных покупок на момент недоступности интернет-магазина по какой-либо причине. А также минимизации возможного отказа от использования сервиса пользователями в будущем из-за возникающих сбоев в работе приложения, что может нести за собой репутационный ущерб.  

5. Возможность расширения существующего набора метрик, с учетом современных тенденций развития рынка.  

## Описание метода решения  

В качестве решения поставленных задач был выбран комбинированный подход. Для возможности подключения к системе мониторинга различных интернет-магазинов было принято решение о реализации некоторого программного интерфейса приложения с применением GraphQL API.  Для хранения аналитических данных была выбрана технология с использованием централизованного хранилища в виде столбчатой базы данных ClickHouse. Для хранения и обработки метрик работоспособности интернет-магазина была выбрана технология с применением базы данных временных рядов Prometheus. Для визуализации данных и оперативного оповещения о возникающий инцидентах был выбран инструмент Grafana. Предлагаемая архитектура описанного выше решения представлена на рисунке 1.  

![](https://github.com/AngelinaKalyaeva/1-2019/blob/master/%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0.png)  
Рисунок 1 - Архитектура системы мониторинга  

GraphQL API – технология, представленная в виде типизированного языка запросов к серверу, которая позволяет обращаться с данными по аналогии с существующими языками взаимодействия с базами данных. Выбор данной технологии обусловлен необходимостью интеграции разрабатываемой системы мониторинга с различными интернет-магазинами, что при использовании методологии REST, привело бы к необходимости постоянных доработок и поддержки описываемого решения со стороны разработчиков. GraphQL API  позволяет упрощать процесс интеграции разрабатываемой системы мониторинга бизнес-процессов и работоспособности с различными интернет-магазинами.  

ClickHouse – столбчатая система управления базами данных из семейства NoSQL Database, предназначенная специально для хранения и обработки аналитических метрик. Данное решение было выбрано для системы мониторинга, так как оно имеет SQL-подобный язык для взаимодействия. В качестве решения для обработки данных ClickHouse использует подход MapReduce, который упрощает горизонтальное масштабирование для ускорения обработки данных, что с учетом постоянных изменений тенденций рынка, а соответственно и увеличения объема обрабатываемых метрик, является существенным преимуществом.    

Prometheus – экосистема инструментов, которая включает в себя базу данных временных рядов и используется для аналитики данных, связанных с работоспособностью приложения. В состав Prometheus входят следующие компоненты: сервер, который считывает метрики и сохраняет их в базу данных, дашборд для визуализации описанных метрик, компонент для приема кратковременных процессов, менеджер уведомлений [7].   

Существует два подхода для сбора метрик работоспособности приложения: push и pull[8]. Каждый из упомянутых выше подходов используется для решения определенных задач.  

Задачи, решаемые при помощи Push-модели:  
   * Отправка данных сразу после их создания, за счет чего обеспечивается немедленное обнаружение проблемы и постоянный мониторинг
   * Доставка метрик, генерируемых кратковременными процессами, для которых может не хватить времени для обнаружения или преобразования в конфигурацию с помощью монитора на основе Pull-модели.
   * Контроль отправляемых метрик с точки зрения направления и времени отправки.
   * Увеличение производительности, за счет использования UDP   
      
Задачи, решаемые при помощи Pull-модели:    
   * Репликация собираемых метрик для обеспечения надежности хранения
   * Контроль объема и подлинности собираемых метрик
   * Обеспечение отказоустойчивости за счет контроля над собираемыми метриками.
   * Мониторинг динамики ресурсов сервера, таких как потребляемые ресурсы процессора, использование дискового пространства, использование оперативной памяти и т.д.
   * Снижение нагрузки на передачу данных по сети с допустимым процентом несогласованности в метриках.  
      
Prometheus был выбран в качестве основного решения для системы мониторинга работоспособности, так как в основе этой технологии лежит Pull-модель, которая обеспечивает решение выше перечисленных проблем. В тоже время данное решение подходит для работы с кратковременными процессами, так как в Prometheus используется pushgateway, который реализует Push-модель. Возможность реализации, как Push, так и Pull-модели для мониторинга работоспособности интернет-магазина является необходимостью, так как существуют краткосрочные процессы, например, пики потребления ресурсов процессора, оперативной памяти и т.п. В тоже время основная часть отслеживаемых метрик является длительными процессами, что при использовании Pull-модели позволяет не перегружать систему мониторинга.   

Grafana – инструмент для визуализации метрик и оповещения о настроенных инцидентах. Был выбран в качестве решения одной из поставленных задач, так как объединяет в себе сразу несколько необходимых для системы мониторинга работоспособности и бизнес-процессов интернет-магазина с возможностью оперативного оповещения функций.   

## Исследование метода решения

В качестве API для взаимодействия с интернет-магазинами и проверки гипотезы о работоспособности предлогаемого подхода к мониторингу локально был развернут веб-сервис, написанный на языке Java с использованием технологий Spring Boot и GraphQL API, который использует типизированную схему данных, которую можно представить в json-подобном формате. Поскольку система мониторинга должна взаимодействать как с метриками работоспособности, так и с аналитическими метриками, то внутри схемы данных было вынесено два независимых подмножества элементов.   

В первую очередь был рассмотрен ряд метрик работоспособности приложения, который впоследствии может расширяться:
  * Ошибки платежной системы. Взаимодействие с платежной системой происходит посредством протокола HTTPS, поэтому было принято решение о сохранении (в базу данных временных рядов) кодов ответа сервера платежной системы. В качестве метрики рассчитывается соотношение успешных ответов сервера к ошибкам за определенный интервал времени, который может быть настроен клиентом. Также учитывается количество невыполненных платежей, которые находятся в очереди. 
  * Ошибки по обращению к URL. Взаимодействие с интернет-магазинами осуществляется по определенным протоколам, к примеру, HTTP протокол. Таким образом, для отслеживания ошибок по обращению к URL было принято решение о сохранении кода ответа в базу данных временных рядов. В качестве метрики рассчитывается процент успешных обращений за определенный промежуток времени, который может быть настроен пользователем. 
  * Тайминги на обращение к URL. Для каждого URL пользователем задается соглашение сервисного уровня о времени ответа сервера для выполнения определенного запроса. Таким образом, для каждого URL было принято решение о сохранении результата выполнения соглашения. В качестве метрики рассчитывается отношение успешных ответов сервера к неуспешным за определенный промежуток времени, который может быть настроен пользователем. 
  * Снижение количества запросов в секунду. Для каждого URL, который предоставляет интернет-магазин, рассчитывается количество завпросов в секунду на текущий момент времени. В качестве метрики рассчитывается процент снижения количества запросов по сравнению с предыдущим днем.(или лучше сделать по отношению к такому же дню на предыдущей неделе) 
  * Ошибки при обращении к базе данных - успешность выполнения запросов к базе данных интернет магазина (что значит успешность?)
  * Тайминги на работу с базой данных - время ответа запросов при обращении к базе данных. (тут тоже непонятно, что имеется ввиду)
  * Метрики на ресурсы сервиса. В качестве метрик ресурсов сервиса выделены: нагрузка на процессор, оперативная память, нагрузка на сеть, заполненность жестких дисков.
  
В качестве аналитических метрик были выбраны:   
  * Посещаемость магазина. В качестве метрики коэффициент посещаемости: ![equation](https://latex.codecogs.com/svg.latex?k_{pos}=\frac{N_{pos}}{t}), где 
  ![equation](https://latex.codecogs.com/svg.latex?N_{pos}) - количество обращений к сайту за время ![equation](https://latex.codecogs.com/svg.latex?t), кторое может быть настроено пользователем системы мониторинга. Для своевременного обнаружения изменений посещаемости магазина настройка оповещений:
  ![equation](https://latex.codecogs.com/svg.latex?alert(\frac{k_{pos}}{avg(k_{posn})}<P)), где ![equation](https://latex.codecogs.com/svg.latex?k_{posn}) - коэффициент посещаемости за определенный выбранный промежуток времени, ![equation](https://latex.codecogs.com/svg.latex?P) - настраиваемый процент, с которым производится сравнение.
  * Динамика продаж. В качестве метрики коэффициент продаж: ![equation](https://latex.codecogs.com/svg.latex?k_{pr}=\frac{N_{pr}}{t}), где ![equation](https://latex.codecogs.com/svg.latex?N_{pr}) - количество обращений к сайту за время ![equation](https://latex.codecogs.com/svg.latex?t), кторое может быть настроено пользователем системы мониторинга. Для своевременного обнаружения изменений динамики продаж  интернет-магазина настройка оповещений:
  ![equation](https://latex.codecogs.com/svg.latex?alert(\frac{k_{pr}}{avg(k_{prn})}<P)), где ![equation](https://latex.codecogs.com/svg.latex?k_{prn}) - коэффициент посещаемости за определенный выбранный промежуток времени, ![equation](https://latex.codecogs.com/svg.latex?P) - настраиваемый процент, с которым производится сравнение.   
  * Процент отказов от покупок. Для своевременного обнаружения изменения процента отказов от заказов настройка оповещений: ![equation](https://latex.codecogs.com/svg.latex?alert(\frac{N_{ot}}{N}>P)), где ![equation](https://latex.codecogs.com/svg.latex?N_{ot}) - количество отказов от заказов, ![equation](https://latex.codecogs.com/svg.latex?N) - общее число заказов за время ![equation](https://latex.codecogs.com/svg.latex?t), кторое может быть настроено пользователем системы мониторинга, ![equation](https://latex.codecogs.com/svg.latex?P) - настраиваемый процент, с которым производится сравнение.
  * Средний чек покупки. Данный параметр необходим для наблюдения динамики интернет-магазина. В качестве метрики: ![equation](https://latex.codecogs.com/svg.latex?avg(sum(c))), где ![equation](https://latex.codecogs.com/svg.latex?c) - стоимость товара в чеке.
  * Популярность товара
count(P)avg(countPобщ)– , где P - количество покупок данного товара, Pобщ – количество всех покупок 
  * Остаток товара 
count(H) , где H – остаток товара на складе
алерт?
  * Время заказов
avg(tд-tз), где tд – время доставки, tз – время заказа
  
Таким образом предложенная схема для взаимодествия с интернет-магазинами:
metrics {
  service {
    id
    name
    datetime
    analitics {
      attendance {
        url
        count
        time
      }
      dynemic{
        sale {
          products_list
          count
          time
        }
        delay {
          user_id
          products_list
          count
          time
      }
      product {
        id
        popularity {
          time
          sales_count
        }
        balance {
          count
        }
      }
      delivery {
        id  
        order_time
        delivery_time
      }
    }
    efficiency {
      payment{
        success
        type
        hold_billings
      }
      sla {
        url
        error {
          percent
          success
        }
        timing {
          time
          sla_time
          percent
          success
        }
      }
      drop {
        url
        rps
      }
      database {
        query
        error {
          percent
          success
        }
        timing {
          time
          sla_time
          percent
          success
        }
      }
      cpu_percent
      ram_percent
      net_percent
      mem_percent
    }
  }
}


## Заключение   

В данной статье был проведен обзор предметной области и сравнение существующих решений с точки зрения возможности оповещения в случае возникновения неполадок, возможности обеспечения мониторинга работоспособности интернет-магазина, возможности обеспечения мониторинга аналитических метрик, возможности расширения набора метрик с учетом изменения тенденций рынка. В результате обзора аналогов был сделан вывод о целесообразности разработки системы мониторинга работоспособности и бизнес-процессов интернет-магазина с возможностью оперативного оповещения. Для формирования подхода к мониторингу в данной статье были рассмотрены Push и Pull-модели взаимодействия отслеживаемых серверов с системой мониторинга. Были выделены задачи, для решения которых предназначена Pull-модель и задачи, для решения которых предназначена Push-модель. В данной статье была выдвинута гипотеза о формировании комбинированного подхода к мониторингу с применением технологий: GraphQL, ClickHouse, Prometheus, Garfana для обеспечения необходимого функционала системы мониторинга интернет-магазина. В дальнейшем планируется более детально рассмотреть процесс формирования метрик с помощью выбранной технологии GraphQL.


## Список литературы    
1. Егорова И. Н., Кадушкевич О. Н. Методика эффективного использования инструментов Google Analytics //ScienceRise. – 2016. – Т. 1. – №. 2 (18).  
2. Справка - Google Analytics / URL: https://support.google.com/analytics/?hl=ru#topic=9143232 (Дата обращения: 26.11.2020)  
3. Host-tracker / URL: https://www.host-tracker.com/ru/ (Дата обращения: 26.11.2020)   
4. Яндекс справка / URL: https://yandex.ru/support/metrica/user-cases/online-store.html (Дата обращения 26.11.2020)  
5. Ping-admin.ru / URL: http://ping-admin.ru/ (Дата обращения 26.11.2020)  
6. Kuoll - Crunchbase Company Profile & Funding / URL: https://www.crunchbase.com/organization/kuoll (Дата обращения 26.11.2020)  
7. Маратканов А. С., Суханов А. А., Воробьева А. А. Средства анализа и визуализации метрик работы приложения //International scientific review. – 2019. – №. LIX.  
8. Huang H., Wang L. P&P: A combined push-pull model for resource monitoring in cloud computing environment //2010 IEEE 3rd International Conference on Cloud Computing. – IEEE, 2010. – С. 260-267.  
